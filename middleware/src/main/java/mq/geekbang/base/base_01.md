### 衍生内容:如何设计一个秒杀系统

秒杀系统需要解决什么样的 **核心问题** ? 
```
短时间内,利用有限的服务器资源,如何处理海量的数据请求?
```

秒杀系统几乎可以分为以下几个步骤
1. 风险控制
2. 库存锁定
3. 生成订单
4. 短信通知
5. 统计数据

最关键的就是 1,2 两步,只要用户的秒杀请求,通过了风险控制和库存锁定,那么就可以认为这笔请求秒杀成功了

至于后续的 3,4,5 三步,则不是秒杀系统需要关注的重点了,可以交给异步任务慢慢处理

所以当服务器完成前两步的任务后,就可以把秒杀结果放到异步消息队列里面去,然后返回处理下一个秒杀请求

这样将一个完整的购物请求,分解为核心的 2 个步骤,在短时间内通过有限的资源处理这 2 个核心步骤,可以处理更多的秒杀请求

消息队列在其中起到一个实现 **异步处理** 的作用,这样可以有以下好处

1. 更快地返回结果
2. 提高服务器的并发请求数,提升性能

### 衍生内容:如何做流量控制

秒杀系统如何做流量控制,如果秒杀开始后大量流量立即涌入后端服务,势必带来不小的压力

考虑在网关服务和后端服务之间,增加一个消息队列里; 通常来说网关处理请求的效率要比实际的后端服务高很多,因为没有业务逻辑的干扰

所以网关能够承受更大的流量压力,然后网关将秒杀请求放进消息队列里; 后端服务则按照自身实际的最大处理能力,从消息队列里处理真实的秒杀请求

这样减少了后端服务的流量压力,对后端服务来说做到了流量控制

但是这样做也有弊端:
1. 增加了消息队列的中间层,增加了调用链,也增加了全链路的耗时
2. 后端服务和网关服务之间的通信方式由同步改为了异步,导致系统的复杂度变高

### 衍生内容:流量控制如何做的更优雅? 令牌桶

如果能够预估出秒杀服务的大值流量范围,则可以按照一定比例构造出一个具有若干令牌的令牌桶,来实现更为简单的流量控制

令牌桶的原理: 
1. 单位时间内只会发放一定数量的令牌到令牌桶内
2. 同时约定后端服务若想要处理请求,则必须先持有一个有效的令牌才行
3. 若令牌桶内没有有效令牌,则后端服务必须拒绝请求
4. 这保证了在单位时间内,最大可以处理的请求数量,实现了简单的流量控制

令牌桶的简单实现:
1. 令牌发生器匀速地产生令牌放入令牌桶内
2. 若令牌桶已满,则丢弃令牌
3. 后端服务在接收到请求后,会先从令牌桶内尝试获取一个有效的令牌
4. 若无有效令牌,后端服务则拒绝请求

### 衍生内容:服务解耦

考虑电商系统

订单服务负责产生实际的订单
支付服务负责发起支付流程
风控服务负责检测支付是否正常
通知服务负责将订单内容通知给客户
审计服务负责统计订单数据

下游每个服务都依赖订单服务产生的订单,如果每个服务都获取的是一个订单的子集,那么订单服务就不得不花费大量的时间去给每个下游服务定制参数

这样每个下游服务的改变,都将导致订单服务发生变动

考虑引入消息队列,订单服务每次将产生的订单投递到消息队列里

下游服务通过 **订阅** 消息队列,这样每次有新的订单消息产生,下游服务都能各自接收到一份完整的订单信息

这样下游服务的改动就不依赖于上有的订单服务了,实现了服务间的解耦

### 消息队列不仅仅可以作为 秒杀系统,流量控制,服务解耦

* 通过消息队列进行发布/订阅, 实现微服务之间的简单观察者设计模式
* 将消息广播给大量接收者
* 等等

### 消息队列本身也有缺陷

* 引入消息队列会导致服务间的耗时增加
* 通信方式由同步变为异步,增大了系统的复杂程度
* 消息队列本身也不是完全可靠的,可能会导致数据的前后不一致