## 如何处理消息积压

产生消息积压的问题,一定是系统出现了性能问题,导致无法及时处理消息队列当中的消息,从而导致消息积压

通常来说,单纯的消息队列中间件的处理性能是很优秀的,每秒处理几十万消息不在话下

然而大多数时候链路上的性能耗时几乎都是集中在业务代码,业务系统上一个单节点每秒钟处理几百上千条请求已经算得上是性能很好的了

对于消息队列的性能优化,其重点更应该放在消息的发送端和消费端两者如何平衡之间的速率,配合消息队列得到最佳的系统性能

### 发送端的优化

发送端的优化有两种最简单的方式

1. 并发发送 

2. 假设一个单线程服务,发送消息到接收到消息队列的 ack,这一次完整的交互过程耗时 1ms

那么这个单线程服务 1s 最多就只能发送 1000 条消息

通常我们使用微服务开发,服务与服务之间采用 RPC 通信,而主流的 RPC 框架都是天生支持多线程并发请求的

将原来的单线程服务改用 RPC 框架开发,业务线程仍然是单线程,但是网络 IO 线程由 RPC 框架提供多线程支持

如果框架提供了 100 个并发,那么整个服务 1s 中就能发送 100*1000 = 10w 条消息,大大提升了服务的吞吐量

2. 批量发送

如果是一个类似离线任务的后台处理服务,对时延并无任何要求,那么可以把数据汇总后,批量发送给消息队列

例如从数据库里多次批量读取数据,汇总后一次性发给消息队列,在少量并发的实例上,一样能获得很高的吞吐量

### 消费端的优化

然而实际情况,大多数性能问题都是发生在消费端上; 因为从业务设计上来说,消费端通常需要对处理比较复杂的业务,性能相对于发送端来说要低很多

在设计系统的时候,有个很重要的原则: 如果有引入消息队列,消费端的性能设计上一定要由于发送端,这样的服务才能健康稳定地运行



