主从模式下，如果从节点发生故障；客户端还可以继续向主节点或者其他从节点发起请求

如果主节点发生故障，那就会直接影响到主从同步，因为没有主节点可以进行数据复制的操作了

或者写请求再主从模式的读写分离的要求下，所有的写请求将会被拒绝，整个服务对外将不可用

## Redis的哨兵机制

redis提供哨兵机制来自动实现主从库的切换

#### 基本流程

Redis的哨兵是一个运行在特殊模式下的redis进程，通常由多个节点组成，这样避免当单个哨兵挂掉后，其他节点的哨兵还能继续提供主从切换

哨兵负责当主节点挂掉后，自动选择一个最优的从节点切换为主节点。

1. 客户端连接集群时，会首先连接哨兵，通过哨兵来查询主节点的地址，在通过这个地址来连接主节点进行数据操作
2. 当主节点发生故障时，客户端重新连接到哨兵，得到选举产后的新主节点地址
3. 客户端继续通过新的主节点地址得到服务

#### 哨兵的任务

* 监控

指哨兵在运行时，周期性地向其他主从节点发送心跳包（PING命令）

如果从节点在规定时间内没有响应心跳包，哨兵就会标记从节点为 **下线状态**

如果主节点没有在规定时间内响应星跳包，哨兵就会认为 **主节点下线** ，然后开始 **自动切换主节点** 的流程

* 选主

当开始主从切换流程后，哨兵需要从很多个从库当中，按照一定规则选择一个从节点，把它升级为新的主节点

* 通知

当新的主节点产生后，哨兵会把新的主节点连接信息发送给其他从库，其他从库执行replicaof命令，重新和主节点建立连接，进行主从同步。

同时哨兵会把新的主节点连接信息发送给客户端，这样客户端就会重新请求新的主节点

![image-20220307153032810](E:\learning-note\middleware\src\main\java\redis\极客时间\pic\image-20220307153032810.png)



#### 主观下线和客观下线

对于从节点，如果哨兵长时间没有收到从节点的心跳包，可以 **主观** 地认为从节点发生故障，把它标记为下线。因为从节点一般有很多个，一两个发生故障并不会影响整个系统对外提供的服务

而对于主节点，就不能简单地将主节点标记为 **主观下线** ，从而启动主从切换。

很有可能哨兵存在误判情况，起始主节点并没有发生故障，而是哨兵到主节点之间的网络出现了故障，或者哨兵本身出现了故障；这样因为误判启动主从切换，后续的选主和通知过程也会带来额外的开销

**判断主节点下线的原则：少数服从多数**

通常哨兵也采用多个实例部署的方式运行，只有当超过 (N/2)+1 个哨兵认定主节点为 **主观下线** 后，才会开始整个集群的主从切换，这样可以减少误判的概率，避免不必要的主从切换发生

![image-20220307153913094](E:\learning-note\middleware\src\main\java\redis\极客时间\pic\image-20220307153913094.png)



### 如何选择主节点

过程简单概括为 **筛选+打分**

1. 先按照一定的**筛选条件**，去掉不符合条件的从节点

肯定是要选择上线状态的从节点，而且还要选择网络状态好的从节点

如果一个从节点总是和主节点断连，且断连次数超过一定阈值，那么也是不符合条件的

2. 按照一定的**打分规则**，将得分最高的从节点选为新的主节点

按照三个规则进行打分，**从库优先级、从库复制进度、从库ID号**

只要在一轮当中，又从库获得了最高分，那么它就是主库了。若没有出现最高分的从库，就进行下一轮选举

##### 第一轮：优先级最高的从库获得最高分

可以通过手动配置从库的优先级 **slave-priority** 配置不同的优先级，一般将机器配置更高的从节点设置更高的优先级，这样哨兵会给优先级更高的从节点打高分

如果所有从节点优先级都一样，则会开始第二轮打分

##### 第二轮：主从同步最接近的从节点的最高分

如果某个从节点和主节点的同步进度最接近，那么这个从节点上有更大概率有最新的数据。

在主从同步中，从节点通过psync命令传递主节点的runID和自己的同步进度slave_offset

同时主节点在同步缓冲区buffer当中也维护了环形数组的master_offset偏移量

如果有从节点的slave_offset最接近主节点的master_offset，那么这个从节点的得分更高

![image-20220307155137999](E:\learning-note\middleware\src\main\java\redis\极客时间\pic\image-20220307155137999.png)

如果最接近主节点同步进度的从节点有多个，就开始第三轮的选举

##### 第三轮：ID号最小的从库得最高分

每个redis实例都有一个ID，在进行主从同步时，选ID号最小的从节点得最高分



#### 简单使用

客户端通过哨兵发现主节点得地址，然后建立对应的连接放入连接池维护

客户端具体请求将会从连接池中拿出一个可用的连接来使用



##### 当哨兵发生主从切换时，客户端如何感知到地址变更

redis客户端在建立连接时进行了主节点地址的判断

建立连接时，主动查询主节点地址，然后跟客户端内存中维护的主节点地址进行对比

如果发生了变更，就会断开所有已有的连接，使用新的主节点地址建立新的连接

##### 当主从切换发生时，如果主节点没有挂掉，但是之前主节点建立的连接已经在使用了，而不是新的连接，是否会产生不一致

客户端在处理写命令时，会捕获一个ReadOnlyError异常，这个异常里面所有的旧连接都会被关闭

当主节点被降级到从节点时，这段期间收到的所有写指令，都会返回ReadOnlyError异常

如果没有写指令，只有读指令，即使连接不切换也不影响数据的读取，所以不重新建立连接也没关系



## 哨兵之间如何通信

哨兵通过Redis提供的 **发布/订阅** 机制实现通信

在主节点上，有一个名为sentinel__:hello的频道，不同的哨兵都会订阅这个频道

![image-20220307163356998](E:\learning-note\middleware\src\main\java\redis\极客时间\pic\image-20220307163356998.png)



不同的哨兵通过主节点的频道订阅/发布消息，来完成互相之间的发布

#### 哨兵如何知道从库的ip地址和端口

哨兵主动向主节点发送info指令，当主节点接收到info指令后，就会把从节点的信息列表返回给哨兵

哨兵就可以从信息列表里面获得从节点的连接信息，从而和每个从节点建立连接，并且持续监控从节点

#### 客户端如何通过哨兵了解点主从切换的过程

仍然通过reidis的 **订阅/发布** 机制，来完成哨兵和客户端之间的信息同步

**哨兵实质上是一个以特殊模式运行的Redis实例**，它也可以对外提供 **订阅/发布** 机制

![image-20220307164143786](E:\learning-note\middleware\src\main\java\redis\极客时间\pic\image-20220307164143786.png)

客户端可以从哨兵实例那里 **订阅这些频道** ，当频道上有消息产生时，就可以通过消息得知主从切换的进度

#### 由哪个哨兵主导进行主从切换

和主节点的 **客观下线（由大多数哨兵投票得出主节点下线）** 类似，哨兵之间也有一个 **投票** 的过程

1. 任何一个哨兵节点判断主节点 **主观下线** 之后，会立即给其他哨兵节点发送 `is_master_down_by_addr` 命令
2. 其他哨兵接收到 `is_master_down_by_addr` 命令后，根据自身和主节点的连接关系，发送 **Y** 或者 **N** 响应给发起投票的哨兵
3. 当发起 `is_master_down_by_addr` 命令的哨兵收到了足够数量的**赞成票**之后，就可以把主节点标注为 **客观下线** ，这个票数n通过配置决定，超过n张即可认为通过 **包括发起投票的节点会给自己投出一张赞成票**
4. 上述过程成为 **Leader选举**，通过选举的哨兵成为 **Leader** ，主从切换将由 **Leader** 哨兵节点来执行

满足以下两个条件成为哨兵的 **Leader**

* 收到超过半数以上的赞成票
* 收到超过配置的赞成票数量

哨兵Leader选举，如果一个节点收到多个选举消息，根据时间先后回复赞成和拒绝

例如

![image-20220307165615608](E:\learning-note\middleware\src\main\java\redis\极客时间\pic\image-20220307165615608.png)

在T3时刻，S1收到了S3的选举请求，由于S1在T1已经给自己投了赞成票，所以无法再给其他节点投赞成票，所以S1回复N

同时，在T3，S2先收到S3的选举请求，**哨兵会给第一个收到选举请求的节点投赞成票，后续的选举只会投反对票**，所以S2给S3投赞成票

同时S2后收到S1的选举，由于已经给S3投过赞成票了，所以S2给S1投反对票

最终S3成为哨兵的Leader，接着开始进行选主操作，选主完成后也会将新的主节点信息同步给所有客户端和从节点



#### 选举超时

如果S3没有拿到2张赞成票，那么这一轮投票就不会产生新的Leader

在哨兵集群等待（故障转移超时时间的2倍）之后，重新进行选举，直到新的Leader产生

#### 注意事项

如果哨兵只有2个，如果一个哨兵想要成为Leader，它必须获得2张赞成票

所以如果有1个哨兵挂掉了，那么这个时候只有1个哨兵的redis集群是无法进行主从切换的

通常至少配置3个及以上的哨兵实例

































































































