### 预备知识

java的方法是在 **栈帧** 里面执行的，java的栈保存的主要内容是栈帧，每一次方法调用时，就有一个对应的栈帧被压入栈，方法调用结束时就有一个对应的栈帧被弹出。

栈帧主要存存储以下三个信息：

1. 操作数栈：用于保存方法中 **正在执行的** 表达式的操作数。

2. 局部变量区：用来保存方法中使用的变量，包括方法参数，方法内部声明的变量，以及方法中使用到的对象的成员变量或类的成员变量（静态变量）。

3. 字节指令码区。

### return原理

这里我们主要研究的是 `return [expression]` 也就是 return 语句后面跟着的是一个表达式的情况。

由于返回的是return指令执行的时刻，操作数栈顶的值，无论 expression 表达式是什么样的，或者做了什么，它对于 return 来说都不重要，因为 return 只返回操作数栈顶的数值。

return expression 主要由一下两个部分组成：

1. 执行 expression

2. 执行 return 返回操作数栈顶数值

例如：
```
return x + y;
```
上述代码先计算 x + y 表达式的值，具体过是：先将 x 和 y 从局部变量区复制到操作数栈顶，然后执行 x + y 操作，这时 x + y 的结果会保存在操作数栈顶，最后执行 return 指令返回操作数栈顶的数值。

对于
```
return x;
```
先执行x，x也是一个表达式，这个表达式只有一个操作数，会执行将变量x从局部变量区复制到操作数栈顶的指令，然后执行 return 返回操作数栈顶的值。因此 return x 实际返回的是 return 指令执行时，x在操作数栈顶的一个快照或者叫副本，而不是x这个值。

### 同时存在 return 和 finally 时的执行顺序

1. 执行：expression，计算该表达式，结果保存在操作数栈顶

2. 执行：操作数栈顶值（expression的结果）复制到局部变量区作为返回值

3. 执行：finally语句块中的代码

4. 执行：将第2步复制到局部变量区的返回值又复制回操作数栈顶

5. 执行：return指令，返回操作数栈顶的值

可以看到的是，在第一步执行完后，整个 return 语句的返回值也就确定下来，后面 finally 语句块中的代码更改返回值表达式是不会影响到真正的返回值的。因为它实际上改动的是操作数栈的一个快照，而不是真正的返回值。

**但是如果 finally 语句块里面又含有了 return 语句，那么就会将新的操作数栈顶作为返回值。**